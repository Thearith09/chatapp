<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="container">
        <div id="namesWrapper">
            <h2>UBB Chat App</h2>
            <p>Create Username</p>
            <div id="error"></div>
            <form id="usernameForm">
                <input type="text" onfocus="this.value=''" id="username" required>
                <input type="submit" value="submit">
            </form>
        </div>

        <div id="mainWrapper">
            <h2>UBB Chat App</h2>
            <div id="chatWrapper">
                <div id="chatWindow"></div>
                <form id="messageForm">
                    <textarea name="text" id="textarea" cols="88" rows="1"></textarea>
                    <button id="send">Send</button>
                </form>
            </div>
        </div>

        <div id="userWrapper">
            <div id="users"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const $messageForm = $('#messageForm');
        const $username = $('#username');
        const $message = $('#textarea');
        const $chat = $('#chatWindow');
        const $userForm = $('#usernameForm');
        const $users = $('#users');

        $(() => {
            $userForm.submit((e) => {
                e.preventDefault();
                socket.emit('new user', $username.val(), (data) => {
                    if (data) {
                        $('#namesWrapper').hide();
                        $('#mainWrapper').show();
                        $('#userWrapper').show();
                    } else {
                        $('#error').html('Username is taken');
                    }
                })
            })

            $('#send').click(() => {
                event.preventDefault();
                socket.emit('send message', {
                    name: $username.val(),
                    message: $message.val()
                });
                document.getElementById('textarea').value = '';
            });

            socket.on('usernames', (data) => {
                let html = '';
                for (let i = 0; i < data.length; i++) {
                    html += data[i] + '<br>';
                }
                $users.html(html);
            });

            socket.on('new message', ({ name, message }) => {
                $chat.append(`<h4> ${name}: <span> ${message} </span></h4>`);
            });

            socket.emit('disconnect', () => {

            })

        });
    </script>
</body>

</html>